<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Login/Register</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="theme.css" />
</head>

<body class="radialBackground">
    <div class="register main">
        <div class="header">
            <h1>New Around Here?</h1>
            <h2>Sign Up Here:</h2>
            <p><a href="javascript:void(0);" onclick="document.querySelector('.register.main').style.display = 'none'; document.querySelector('.login.main').style.display = 'block';">Already Signed Up?</a></p>
        </div>
        <div class="mainForm">
            <form name="registerForm" action="register" method="POST" enctype="multipart/form-data">
                <div class="flex">
                    <div class="left">
                        <table>
                            <tr>
                                <th>Name:</th>
                                <td><input type="text" required name="name" placeholder="Name..." /></td>
                            </tr>
                            <tr>
                                <td colspan="2" id="emailErrMsg"></td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td><input type="email" required name="email" placeholder="Email..." /><span></span></td>
                            </tr>
                            <tr>
                                <td colspan="2" id="usernameErrMsg"></td>
                            </tr>
                            <tr>
                                <th>Username:</th>
                                <td><input type="text" required name="username" placeholder="Username..." /><span></span></td>
                            </tr>
                            <tr>
                                <td colspan="2" id="passwordErrMsg"></td>
                            </tr>
                            <tr>
                                <th>Password:</th>
                                <td><input type="password" id="password" required name="password" placeholder="Password..." /><span></span></td>
                            </tr>
                            <tr>
                                <th>Confirm Password:</th>
                                <td><input type="password" id="confirmPassword" required name="confirmPassword" placeholder="Confirm Password..." /><span></span></td>
                            </tr>
                            <tr>
                                <td colspan="2" id="confirmPasswordErrMsg"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="right">
                        <div style="text-align: left;">
                            <p style="margin-bottom: 0;">Are you a parent or a child?</p>
                            <label>
                                <input id="parentRadio" type="radio" name="parentOrChild" value="parent" required />
                                Parent
                            </label> &emsp;
                            <label>
                                <input id="childRadio" type="radio" name="parentOrChild" value="child" required />
                                Child
                            </label>
                            <div id="familyid">
                                <p id="familyIDErrMsg"></p>
                                <strong style="font-size: 1.5rem;">Family ID:</strong><input type="text" name="familyID" pattern="[A-Z0-9]{6}" placeholder="Family ID..." /><span></span>
                            </div>
                            <p style="margin-bottom: 0;">Last step, go ahead and upload a profile picture (less than 2MB) so your family can see who you are:</p>
                            <input type="file" name="pfpImage" accept="image/png, image/jpeg" onchange="preview_image(event)" />
                        </div>
                        <!--Preview Image-->
                        <img id="output_image" src="a.a" alt="Select an image" />
                    </div>
                </div>
                <button type="submit" class="button"><span>Register Now!</span></button>
            </form>
            <script>
                //All for Register Validation
                //Global Vars
                var registerForm = document.forms["registerForm"];
                var usernameInputField = registerForm["username"];
                var passwordInputField = registerForm["password"];
                var confirmPasswordInputField = registerForm["confirmPassword"];
                var emailInputField = registerForm["email"];
                var parentOrChildRadioField = registerForm["parentOrChild"];
                var familyIDInputField = registerForm["familyID"];
                //Live Checks:
                //First check if password is >= 8 upper letters, lower letters, numbers, special char
                function checkPasswordValidity(password) {
                    var errorMessage = "";
                    if (!(password.length >= 8)) {
                        //Password is too short
                        errorMessage = "Your password needs to be 8 or more characters";
                    }
                    //Check if password has uppercase letters
                    var arrOfUppercaseLettersFound = password.split("").filter((character) => {
                        var returnValue = false;
                        for (letter of "abcdefghijklmnopqrstuvwxyz".toUpperCase().split("")) {
                            if (character === letter) {
                                returnValue = true;
                            }
                        }
                        return returnValue;
                    });
                    if (arrOfUppercaseLettersFound.length === 0) {
                        //Password has no uppercase letters
                        errorMessage = "Password needs to have at least one uppercase letter";
                    }
                    //Check if password has lowercase letters
                    var arrOfLowercaseLettersFound = password.split("").filter((character) => {
                        var returnValue = false;
                        for (letter of "abcdefghijklmnopqrstuvwxyz".split("")) {
                            if (character === letter) {
                                returnValue = true;
                            }
                        }
                        return returnValue;
                    });
                    if (arrOfLowercaseLettersFound.length === 0) {
                        //Password has no lowercase letters
                        errorMessage = "Password needs to have at least one lowercase letter";
                    }
                    //Check if password has numbers
                    var arrOfNumbersFound = password.split("").filter((character) => {
                        var returnValue = false;
                        for (letter of "1234567890".split("")) {
                            if (String(character) === String(letter)) {
                                returnValue = true;
                            }
                        }
                        return returnValue;
                    });
                    if (arrOfNumbersFound.length === 0) {
                        //Password has no numbers
                        errorMessage = "Password should have at least one number"
                    }
                    //Check if password has special chars
                    var arrOfSpecialCharsFound = password.split("").filter((character) => {
                        var returnValue = false;
                        for (letter of "!@#$%^&*()".split("")) {
                            if (character === letter) {
                                returnValue = true;
                            }
                        }
                        return returnValue;
                    });
                    if (arrOfSpecialCharsFound.length === 0) {
                        //Password has no special chars
                        errorMessage = "Password requires one of the following special characters: " + "!@#$%^&*()".split("").join(" ");
                    }
                    return errorMessage;
                }
                passwordInputField.addEventListener("keyup", () => {
                    //console.log(event);
                    var errorMessage = checkPasswordValidity(passwordInputField.value);
                    if (errorMessage === "") {
                        //If there is no error message, donesies
                        document.querySelector("#passwordErrMsg").innerHTML = errorMessage;
                        passwordInputField.classList.remove("invalidInputField");
                        passwordInputField.classList.add("validInputField");
                    } else {
                        passwordInputField.classList.add("invalidInputField");
                        passwordInputField.classList.remove("validInputField");
                        document.querySelector("#passwordErrMsg").innerHTML = errorMessage;
                    }
                });
                //Second check if passwords match
                confirmPasswordInputField.addEventListener("keyup", () => {
                    var confirmPasswordErrMsg = document.querySelector("#confirmPasswordErrMsg");
                    if (passwordInputField.value === confirmPasswordInputField.value) {
                        //If there is no error, donesies
                        confirmPasswordInputField.classList.remove("invalidInputField");
                        confirmPasswordInputField.classList.add("validInputField");
                        confirmPasswordErrMsg.innerHTML = "<span style='color: green;'>Passwords match</span>";
                    } else {
                        confirmPasswordInputField.classList.remove("validInputField");
                        confirmPasswordInputField.classList.add("invalidInputField");
                        confirmPasswordErrMsg.innerHTML = "<span style='color: red;'>Passwords do not match</span>";
                    }
                });
                //Check if familyID matches regex pattern ^[A-Z0-9]{6}$
                familyIDInputField.addEventListener("keyup", () => {
                    if (/^[A-Z0-9]{6}$/.test(familyIDInputField.value)) {
                        //Matches Regex
                        document.querySelector("#familyIDErrMsg").innerHTML = "";
                        familyIDInputField.classList.remove("invalidInputField");
                        familyIDInputField.classList.add("validInputField");
                    } else {
                        document.querySelector("#familyIDErrMsg").innerHTML = "The Family ID should be a 6 digit ID containing only numbers and uppercase letters";
                        familyIDInputField.classList.remove("validInputField");
                        familyIDInputField.classList.add("invalidInputField");
                    }
                });

                //Form onSubmit (this is not a live check because too many database calls if on every keyup)
                //Then check if username, email already exists or if Family ID does not exist
                function validateRegisterForm(event) {
                    event.preventDefault();
                    var fetchURL = `/check-registration?username=${usernameInputField.value}&email=${emailInputField.value}&parentOrChild=${parentOrChildRadioField.value}&familyID=${familyIDInputField.value}`;
                    fetch(fetchURL, {
                            method: "GET",
                            headers: {
                                "XMLHttpRequest": true
                            }
                        })
                        .then((response) => response.json())
                        .then((responseJSON) => {
                            console.log(responseJSON);
                            /*
                            {
                                usernameExists: boolean,
                                emailExists: boolean,
                                familyIDExists: boolean
                            }
                            - Username already exists ("I'm sorry but the username you were looking for has already been taken")
                            - Email already exists ("There is already an account under this email, try logging in")
                            - Family ID does not exist ("The family ID you entered was not correct")
                            */
                            //If everything checks out, remove this function out of the way and resubmit
                            if (responseJSON.hasOwnProperty("success") && Boolean(responseJSON["success"])) {
                                registerForm.removeEventListener("submit", validateRegisterForm);
                                registerForm.submit();
                            } else {
                                //RIP they have errors, lay it on them
                                if (responseJSON.hasOwnProperty("usernameExists") && Boolean(responseJSON["usernameExists"])) {
                                    document.querySelector("#usernameErrMsg").innerHTML = "I'm sorry but the username you were looking for has already been taken";
                                    usernameInputField.classList.remove("validInputField");
                                    usernameInputField.classList.add("invalidInputField");
                                } else {
                                    document.querySelector("#usernameErrMsg").innerHTML = "";
                                    usernameInputField.classList.remove("invalidInputField");
                                    usernameInputField.classList.add("validInputField");
                                }
                                if (responseJSON.hasOwnProperty("emailExists") && Boolean(responseJSON["emailExists"])) {
                                    document.querySelector("#emailErrMsg").innerHTML = "There is already an account under this email, try logging in";
                                    emailInputField.classList.remove("validInputField");
                                    emailInputField.classList.add("invalidInputField");
                                } else {
                                    document.querySelector("#emailErrMsg").innerHTML = "";
                                    emailInputField.classList.remove("invalidInputField");
                                    emailInputField.classList.add("validInputField");
                                }
                                if (responseJSON.hasOwnProperty("familyIDExists") && !Boolean(responseJSON["familyIDExists"])) {
                                    document.querySelector("#familyIDErrMsg").innerHTML = "The family ID you entered was not correct";
                                    familyIDInputField.classList.remove("validInputField");
                                    familyIDInputField.classList.add("invalidInputField");
                                } else {
                                    document.querySelector("#familyIDErrMsg").innerHTML = "";
                                    familyIDInputField.classList.remove("invalidInputField");
                                    familyIDInputField.classList.add("validInputField");
                                }
                            }
                            //Now do nothing, the POST request has already been canceled and the user needs to correct their data
                        });
                }
            </script>
        </div>
    </div>
    <div class="login main">
        <div class="header">
            <h1>Welcome Back,</h1>
            <h2>Login Here:</h2>
            <p><a href="javascript:void(0);" onclick="document.querySelector('.login.main').style.display = 'none'; document.querySelector('.register.main').style.display = 'block';">Don't Have An Account?</a></p>
        </div>
        <div class="mainForm">
            <form name="loginForm" action="login" method="POST">
                <table>
                    <tr>
                        <th>Username:</th>
                        <td><input type="text" required name="username" placeholder="Username..." /></td>
                    </tr>
                    <tr>
                        <th>Password:</th>
                        <td><input type="password" required name="password" placeholder="Password..." /></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <button type="submit" class="button"><span>Login</span></button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <script>
        let familyidElem = document.getElementById('familyid');
        let childRadioElem = document.getElementById('childRadio');

        function displayFamilyID() {
            if (!childRadioElem.checked) familyidElem.style.display = "none";
            else familyidElem.style.display = "block";
        }
        document.forms["registerForm"]["parentOrChild"].forEach((radioElement) => {
            radioElement.addEventListener("click", displayFamilyID);
        });
        /*
                familyidElem.querySelector("input").oninvalid = (event) => {
                    //if (!familyidElem.querySelector("input").checkValidity()) {
                    event.target.setCustomValidity("The Family ID should be a 6 digit ID containing only numbers and uppercase letters");
                    // }
                }
        */

        var pfpImage = document.querySelector("#pfpImage");
        /*pfpImage.addEventListener("change", () => {
            var pfpImageFileSize = pfpImage.files.item(0).size;
            if (Math.round(pfpImageFileSize / 1024) >= 5120) {
                alert("Image file is too large, must be less than 5MB"); //Exit this and try again
                return;
            } else {
                //Image is of size, proceed to canvas to get dataURL and send to server
                var previewPFP = document.querySelector("#previewPFP");
                var file = pfpImage.files[0];
                var reader = new FileReader();
                var result;
                reader.addEventListener("load", () => {
                    previewPFP.src = reader.result;
                    result = reader.result;
                }, false);
                if (file) {
                    reader.readAsDataURL(file);
                }
            }
        }, false);
*/

        function preview_image(event) {
            var output = document.getElementById('output_image');
            output.setAttribute("alt", "Loading...");
            var pfpImageFileSize = event.target.files.item(0).size;
            if (Math.round(pfpImageFileSize / 1024) >= 2048) {
                alert("Image file is too large, must be less than 2MB"); //Exit this and try again
                return;
            } else {
                //Image is of size
                var reader = new FileReader();
                reader.onload = function() {
                    output.src = reader.result;
                    output.setAttribute("alt", "Profile Picture");
                }
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        registerForm.addEventListener("submit", validateRegisterForm);
    </script>
    <img id="trippy_twisty_tabs" src="img/trippy_twisty_tabsCropped.png" />
    <img id="trash_girl" src="img/trash_girl.png" />
    <img id="moneybags_dad" src="img/moneybags_dad.png" />
</body>

</html>